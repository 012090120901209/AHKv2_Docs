<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ComValue | AutoHotkey v2 Documentation</title>
    <meta name="description" content="Wraps a value, SafeArray or COM object for use by the script or for">

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono&display=swap" rel="stylesheet">

    <!-- Styles -->
    <link rel="stylesheet" href="/css/styles.css">
    <link rel="stylesheet" href="/css/sidebar.css">
    <link rel="stylesheet" href="/css/markdown.css">
    <link rel="stylesheet" href="/css/syntax.css">

    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar">
        <div class="navbar-container">
            <div class="navbar-left">
                <button class="sidebar-toggle" id="sidebarToggle" aria-label="Toggle sidebar">
                    <i class="fas fa-bars"></i>
                </button>
                <a href="/" class="navbar-brand">
                    <span class="logo-icon">âš¡</span>
                    <span class="logo-text">AutoHotkey v2</span>
                </a>
            </div>
            <div class="navbar-center">
                <div class="search-box">
                    <i class="fas fa-search search-icon"></i>
                    <input type="text" id="searchInput" placeholder="Search documentation..." autocomplete="off">
                    <kbd class="search-hint">Ctrl+K</kbd>
                </div>
            </div>
            <div class="navbar-right">
                <a href="https://github.com/012090120901209/AHKv2_Docs" class="nav-link" target="_blank" rel="noopener">
                    <i class="fab fa-github"></i>
                    <span>GitHub</span>
                </a>
                <button class="theme-toggle" id="themeToggle" aria-label="Toggle theme">
                    <i class="fas fa-moon"></i>
                </button>
            </div>
        </div>
    </nav>

    <!-- Search Results Dropdown -->
    <div class="search-results" id="searchResults" style="display: none;"></div>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-content">
                <!-- Category Navigation -->
                <div class="sidebar-section">
                    <div class="sidebar-category">
                        <div class="category-header">
                            <i class="fas fa-book"></i>
                            <span>Getting Started</span>
                        </div>
                        <ul class="category-items">
                            <li><a href="/guides/Tutorial.html">Tutorial</a></li>
                            <li><a href="/guides/FAQ.html">FAQ</a></li>
                            <li><a href="/guides/Concepts.html">Concepts</a></li>
                        </ul>
                    </div>

                    <div class="sidebar-category">
                        <div class="category-header">
                            <i class="fas fa-code"></i>
                            <span>Functions</span>
                        </div>
                        <ul class="category-items">
                            <li><a href="/functions/string/">String Functions</a></li>
                            <li><a href="/functions/window/">Window Functions</a></li>
                            <li><a href="/functions/file/">File Operations</a></li>
                            <li><a href="/functions/system/">System Functions</a></li>
                        </ul>
                    </div>

                    <div class="sidebar-category">
                        <div class="category-header">
                            <i class="fas fa-cube"></i>
                            <span>Objects</span>
                        </div>
                        <ul class="category-items">
                            <li><a href="/objects/Array.html">Array</a></li>
                            <li><a href="/objects/Map.html">Map</a></li>
                            <li><a href="/objects/Object.html">Object</a></li>
                            <li><a href="/objects/Gui.html">Gui</a></li>
                        </ul>
                    </div>

                    <div class="sidebar-category">
                        <div class="category-header">
                            <i class="fas fa-hashtag"></i>
                            <span>Directives</span>
                        </div>
                        <ul class="category-items">
                            <li><a href="/directives/_Include.html">#Include</a></li>
                            <li><a href="/directives/_Requires.html">#Requires</a></li>
                            <li><a href="/directives/_HotIf.html">#HotIf</a></li>
                        </ul>
                    </div>

                    <div class="sidebar-category">
                        <div class="category-header">
                            <i class="fas fa-info-circle"></i>
                            <span>Reference</span>
                        </div>
                        <ul class="category-items">
                            <li><a href="/reference/KeyList.html">Key List</a></li>
                            <li><a href="/reference/Hotkeys.html">Hotkeys</a></li>
                            <li><a href="/reference/Variables.html">Variables</a></li>
                            <li><a href="/reference/Language.html">Language</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="content">
            <div class="content-wrapper">
                <!-- Breadcrumb -->
                <nav class="breadcrumb" aria-label="Breadcrumb">
                    <a href="/">Home</a> <i class="fas fa-chevron-right"></i> <span>ComValue</span>
                </nav>

                <!-- Document Content -->
                <article class="markdown-body">
                    <h1 id="comvalue">ComValue</h1>
<p>Wraps a value, SafeArray or COM object for use by the script or for
passing to a COM method.</p>
<pre class="codehilite"><code class="language-Syntax">ComObj := ComValue(VarType, Value , Flags)
</code></pre>

<p><code>ComValue</code> itself is a <a href="Class.htm">class</a> derived from <code>Any</code>, but is
used only to create or identify COM wrapper objects.</p>
<h2 id="Parameters">Parameters</h2>
<dl>
<dt>VarType</dt>
<dd>
<p>Type: <a href="../Concepts.htm#numbers">Integer</a></p>
<p>An integer indicating the type of value. See
<a href="ComObjType.htm#vt">ComObjType</a> for a list of types.</p>
</dd>
<dt>Value</dt>
<dd>
<p>Type: <a href="../Concepts.htm#values">Any</a></p>
<p>The value to wrap.</p>
<p>If this is a pure integer and <em>VarType</em> is not VT_R4, VT_R8, VT_DATE
or VT_CY, its value is used directly; in particular, VT_BSTR,
VT_DISPATCH and VT_UNKNOWN can be initialized with a pointer value.</p>
<p>In any other case, the value is copied into a temporary VARIANT
using the same rules as normal COM methods calls. If the source
variant type is not equal to <em>VarType</em>, conversion is attempted by
calling
<a href="https://learn.microsoft.com/windows/win32/api/oleauto/nf-oleauto-variantchangetype">VariantChangeType</a>
with a <em>wFlags</em> value of 0. An exception is thrown if conversion
fails.</p>
</dd>
<dt>Flags</dt>
<dd>
<p>Type: <a href="../Concepts.htm#numbers">Integer</a></p>
<p>Flags affecting the behaviour of the wrapper object; see
<a href="ComObjFlags.htm">ComObjFlags</a> for details.</p>
</dd>
</dl>
<h2 id="Returns">Return Value</h2>
<p>Type: <a href="../Concepts.htm#objects">Object</a></p>
<p>This function returns a wrapper object containing a <a href="ComObjType.htm#vt">variant
type</a> and value or pointer, specifically ComValue,
ComValueRef, <a href="ComObjArray.htm">ComObjArray</a> or
<a href="ComObject.htm">ComObject</a>.</p>
<p>This object has multiple uses:</p>
<ol>
<li>Some COM methods may require specific types of values which have no
    direct equivalent within AutoHotkey. This function allows the type
    of a value to be specified when passing it to a COM method. For
    example, <code>ComValue(0xB, true)</code> creates an object which represents
    the COM boolean value <em>true</em>.</li>
<li>Wrapping a COM object or SafeArray enables the script to interact
    with it more naturally, using <a href="../Objects.htm#Usage_Objects">object
    syntax</a>. However, the majority of
    scripts do not need to do this manually since a wrapper object is
    created automatically by <a href="ComObject.htm">ComObject</a>,
    <a href="ComObjArray.htm">ComObjArray</a>, <a href="ComObjActive.htm">ComObjActive</a>,
    <a href="ComObjGet.htm">ComObjGet</a> and any COM method which returns an
    object.</li>
<li>Wrapping a COM interface pointer allows the script to take advantage
    of automatic reference counting. An interface pointer can be wrapped
    immediately upon being returned to the script (typically from
    <a href="ComCall.htm">ComCall</a> or <a href="DllCall.htm">DllCall</a>), avoiding the need
    to explicitly <a href="ObjAddRef.htm">release</a> it at some later point.</li>
</ol>
<h2 id="Ptr">Ptr</h2>
<p>If a wrapper object\'s <a href="ComObjType.htm#vt"><em>VarType</em></a> is VT_UNKNOWN (13)
or includes the VT_BYREF (0x4000) flag or VT_ARRAY (0x2000) flag, the
<code>Ptr</code> property can be used to retrieve the address of the object, typed
variable or SafeArray. This allows the ComObject itself to be passed to
any <a href="DllCall.htm">DllCall</a> or <a href="ComCall.htm">ComCall</a> parameter which has
the <code>"Ptr"</code> type, but can also be used explicitly. For example,
<code>ComObj.Ptr</code> is equivalent to <code>ComObjValue(ComObj)</code> in these cases.</p>
<p>If a wrapper object\'s <a href="ComObjType.htm#vt"><em>VarType</em></a> is VT_UNKNOWN (13)
or VT_DISPATCH (9) and the wrapped pointer is null (0), the <code>Ptr</code>
property can be used to retrieve the current null value or to assign a
pointer to the wrapper object. Once assigned (if non-null), the pointer
will be released automatically when the wrapper object is freed. This
can be used with <a href="DllCall.htm">DllCall</a> or <a href="ComCall.htm">ComCall</a> output
parameters of type <code>"Ptr*"</code> or <code>"PtrP"</code> to ensure the pointer will be
released automatically, such as if an error occurs. For an example, see
<a href="ComObjQuery.htm#ExIE">ComObjQuery</a>.</p>
<p>When a wrapper object with <em>VarType</em> VT_DISPATCH (9) and a null (0)
pointer value is assigned a non-null pointer value, its type changes
from <code>ComValue</code> to <code>ComObject</code>. The properties and methods of the
wrapped object become available and the <code>Ptr</code> property becomes
unavailable.</p>
<h2 id="ByRef">ByRef</h2>
<p>If a wrapper object\'s <a href="ComObjType.htm#vt"><em>VarType</em></a> includes the
VT_BYREF (0x4000) flag, empty brackets <code>[]</code> can be used to read or write
the referenced value.</p>
<p>When creating a reference, <em>Value</em> must be the memory address of a
variable or buffer with sufficient capacity to store a value of the
given type. For example, the following can be used to create a variable
which a VBScript function can write into:</p>
<pre class="codehilite"><code>vbuf := Buffer(24, 0)
vref := ComValue(0x400C, vbuf.ptr)  ; 0x400C is a combination of VT_BYREF and VT_VARIANT.

vref[] := &quot;in value&quot;
sc.Run(&quot;Example&quot;, vref)  ; sc should be initialized as in the example below.
MsgBox vref[]
</code></pre>

<p>Note that although any previous value is freed when a new value is
assigned by <code>vref[]</code> or the COM method, the final value is not freed
automatically. Freeing the value requires knowing which type it is.
Because it is VT_VARIANT in this case, it can be freed by calling
<a href="https://learn.microsoft.com/windows/win32/api/oleauto/nf-oleauto-variantclear">VariantClear</a>
with <a href="DllCall.htm">DllCall</a> or by using a simpler method: assign an
integer, such as <code>vref[] := 0</code>.</p>
<p>If the method accepts a combination of VT_BYREF and VT_VARIANT as shown
above, a <a href="../Concepts.htm#variable-references">VarRef</a> can be used
instead. For example:</p>
<pre class="codehilite"><code>some_var := &quot;in value&quot;
sc.Run(&quot;Example&quot;, &amp;some_var)
MsgBox some_var
</code></pre>

<p>However, some methods require a more specific variant type, such as
<code>VT_BYREF | VT_I4</code>. In such cases, the first approach shown above must
be used, replacing 0x400C with the appropriate variant type.</p>
<h2 id="Remarks">General Remarks</h2>
<p>When this function is used to wrap an
<a href="https://learn.microsoft.com/windows/win32/winauto/idispatch-interface">IDispatch</a>
or IUnknown interface pointer (passed as an integer), the wrapper object
assumes responsibility for automatically releasing the pointer when
appropriate. Therefore, if the script intends to use the pointer after
calling this function, it must call
<a href="ObjAddRef.htm"><code>ObjAddRef</code></a><code>(DispPtr)</code> first. By contrast, this is not
necessary if <em>Value</em> is itself a ComValue or ComObject.</p>
<p>Conversion from VT_UNKNOWN to VT_DISPATCH results in a call to
<a href="https://learn.microsoft.com/windows/win32/api/unknwn/nf-unknwn-iunknown-queryinterface(refiid_void)">IUnknown::QueryInterface</a>,
which may produce an interface pointer different to the original, and
will throw an exception if the object does not implement IDispatch. By
contrast, if <em>Value</em> is an integer and <em>VarType</em> is VT_DISPATCH, the
value is used directly, and therefore must be an IDispatch-compatible
interface pointer.</p>
<p>The <em>VarType</em> of a wrapper object can be retrieved using
<a href="ComObjType.htm">ComObjType</a>.</p>
<p>The <em>Value</em> of a wrapper object can be retrieved using
<a href="ComObjValue.htm">ComObjValue</a>.</p>
<p><strong>Known limitation:</strong> Each time a COM object is wrapped, a new wrapper
object is created. Comparisons and assignments such as <code>obj1 == obj2</code>
and <code>arr[obj1] := value</code> treat the two wrapper objects as unique, even
when they contain the same variant type and value.</p>
<h2 id="Related">Related</h2>
<p><a href="ComObjFromPtr.htm">ComObjFromPtr</a>, <a href="ComObject.htm">ComObject</a>,
<a href="ComObjGet.htm">ComObjGet</a>, <a href="ComObjConnect.htm">ComObjConnect</a>,
<a href="ComObjFlags.htm">ComObjFlags</a>, <a href="ObjAddRef.htm">ObjAddRef/ObjRelease</a>,
<a href="ComObjQuery.htm">ComObjQuery</a>, <a href="https://learn.microsoft.com/windows/win32/api/oleauto/nf-oleauto-getactiveobject">GetActiveObject (Microsoft
Docs)</a></p>
<h2 id="Examples">Examples</h2>
<p>::: {#ExByRef .ex}
<a class="ex_number" href="#ExByRef"></a> Passes a VARIANT ByRef to a COM function.</p>
<pre class="codehilite"><code>#Requires AutoHotkey v2 32-bit ; 32-bit for ScriptControl.
code := &quot;
(
Sub Example(Var)
    MsgBox Var
    Var = &quot;out value!&quot;
End Sub
)&quot;
sc := ComObject(&quot;ScriptControl&quot;), sc.Language := &quot;VBScript&quot;, sc.AddCode(code)


; Example: Pass a VARIANT ByRef to a COM method.
var := ComVar()
var[] := &quot;in value&quot;
sc.Run(&quot;Example&quot;, var.ref)
MsgBox var[]

; The same thing again, but more direct:
variant_buf := Buffer(24, 0)  ; Make a buffer big enough for a VARIANT.
var := ComValue(0x400C, variant_buf.ptr)  ; Make a reference to a VARIANT.
var[] := &quot;in value&quot;
sc.Run(&quot;Example&quot;, var)  ; Pass the VT_BYREF ComValue itself, no [] or .ref.
MsgBox var[]
; If a VARIANT contains a string or object, it must be explicitly freed
; by calling VariantClear or assigning a pure numeric value:
var[] := 0

; The simplest way when the method accepts VT_BYREF|VT_VARIANT:
var := &quot;in value&quot;
sc.Run(&quot;Example&quot;, &amp;var)
MsgBox var


; ComVar: An object which can be used to pass a value ByRef.
;   this[] retrieves the value.
;   this[] := Val sets the value.
;   this.ref retrieves a ByRef object for passing to a COM method.
class ComVar {
    __new(vType := 0xC) {
        ; Allocate memory for a VARIANT to hold our value. VARIANT is used even
        ; when vType != VT_VARIANT so that VariantClear can be used by __delete.
        this.var := Buffer(24, 0)
        ; Create an object which can be used to pass the variable ByRef.
        this.ref := ComValue(0x4000|vType, this.var.ptr + (vType=0xC ? 0 : 8))
        ; Store the variant type for VariantClear (if not VT_VARIANT).
        if vType != 0xC
            NumPut &quot;ushort&quot;, vType, this.var
    }
    __item {
        get =&gt; this.ref[]
        set =&gt; this.ref[] := value
    }
    __delete() {
        DllCall(&quot;oleaut32\VariantClear&quot;, &quot;ptr&quot;, this.var)
    }
}
</code></pre>

<p>:::</p>
                </article>

                <!-- Footer Navigation -->
                <div class="doc-pagination">
                    
                    
                </div>

                <!-- Edit on GitHub -->
                <div class="edit-page">
                    <a href="https://github.com/012090120901209/AHKv2_Docs/edit/main/ComValue.md" target="_blank" rel="noopener">
                        <i class="fas fa-edit"></i> Edit this page
                    </a>
                </div>
            </div>

            <!-- Table of Contents -->
            <aside class="toc">
                <div class="toc-wrapper">
                    <h3 class="toc-title">On this page</h3>
                    <nav id="tableOfContents">
                        <div class="toc">
<ul>
<li><a href="#comvalue">ComValue</a><ul>
<li><a href="#Parameters">Parameters</a></li>
<li><a href="#Returns">Return Value</a></li>
<li><a href="#Ptr">Ptr</a></li>
<li><a href="#ByRef">ByRef</a></li>
<li><a href="#Remarks">General Remarks</a></li>
<li><a href="#Related">Related</a></li>
<li><a href="#Examples">Examples</a></li>
</ul>
</li>
</ul>
</div>

                    </nav>
                </div>
            </aside>
        </main>
    </div>

    <!-- Scripts -->
    <script src="/js/theme.js"></script>
    <script src="/js/sidebar.js"></script>
    <script src="/js/search.js"></script>
    <script src="/js/toc.js"></script>
    <script src="/js/syntax.js"></script>
</body>
</html>